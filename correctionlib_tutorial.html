<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Correctionlib tutorial &mdash; correctionlib  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="correctionlib.highlevel" href="highlevel.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            correctionlib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Correctionlib tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Basic-evaluator-usage">Basic evaluator usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Creating-new-corrections">Creating new corrections</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Formulas">Formulas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Converting-from-histograms">Converting from histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Polynomial-fits">Polynomial fits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Resolution-models">Resolution models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Chaining-with-CompoundCorrection">Chaining with CompoundCorrection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Systematics">Systematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Writing-it-all-out">Writing it all out</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Command-line-utility">Command-line utility</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="highlevel.html">correctionlib.highlevel</a></li>
<li class="toctree-l1"><a class="reference internal" href="schemav1.html">Schema v1</a></li>
<li class="toctree-l1"><a class="reference internal" href="schemav2.html">Schema v2</a></li>
<li class="toctree-l1"><a class="reference internal" href="convert.html">correctionlib.convert</a></li>
<li class="toctree-l1"><a class="reference internal" href="core.html">correctionlib._core</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">correctionlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Correctionlib tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/correctionlib_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Correctionlib-tutorial">
<h1>Correctionlib tutorial<a class="headerlink" href="#Correctionlib-tutorial" title="Link to this heading">ïƒ</a></h1>
<p>The purpose of this library is to provide a well-structured JSON data format for a wide variety of ad-hoc correction factors encountered in a typical HEP analysis and a companion evaluation tool suitable for use in C++ and python programs. Here we restrict our definition of correction factors to a class of functions with scalar inputs that produce a scalar output.</p>
<p>In python, the function signature is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>In C++, the signature is:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">Correction::evaluate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;&amp;</span><span class="w"> </span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>The supported function classes include:</p>
<ul class="simple">
<li><p>multi-dimensional binned lookups;</p></li>
<li><p>binned lookups pointing to multi-argument formulas with a restricted math function set (<code class="docutils literal notranslate"><span class="pre">exp</span></code>, <code class="docutils literal notranslate"><span class="pre">sqrt</span></code>, etc.);</p></li>
<li><p>categorical (string or integer enumeration) maps;</p></li>
<li><p>input transforms (updating one input value in place);</p></li>
<li><p>pseudorandom number generation; and</p></li>
<li><p>compositions of the above.</p></li>
</ul>
<section id="Basic-evaluator-usage">
<h2>Basic evaluator usage<a class="headerlink" href="#Basic-evaluator-usage" title="Link to this heading">ïƒ</a></h2>
<p>We can import a previously defined set of correction objects using the</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">correctionlib</span><span class="o">.</span><span class="n">CorrectionSet</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>or from a string with <code class="docutils literal notranslate"><span class="pre">.from_string(&quot;...&quot;)</span></code>. The <code class="docutils literal notranslate"><span class="pre">from_file</span></code> invocation accepts JSON or gzipped JSON data. The <code class="docutils literal notranslate"><span class="pre">CorrectionSet</span></code> acts as a dictionary of <code class="docutils literal notranslate"><span class="pre">Correction</span></code> objects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import correctionlib

ceval = correctionlib.CorrectionSet.from_file(&quot;mycorrections.json&quot;)
list(ceval.keys())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;gen2_to_gen1&#39;, &#39;phimod&#39;, &#39;ptweight&#39;]
</pre></div></div>
</div>
<p>Each correction has a name, description, version, and a input and output specification:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>for corr in ceval.values():
    print(f&quot;Correction {corr.name} has {len(corr.inputs)} inputs&quot;)
    for ix in corr.inputs:
        print(f&quot;   Input {ix.name} ({ix.type}): {ix.description}&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Correction gen2_to_gen1 has 2 inputs
   Input pt (real): pt
   Input eta (real): eta
Correction phimod has 2 inputs
   Input phi (real):
   Input q (int): Particle charge
Correction ptweight has 2 inputs
   Input pt (real): Muon transverse momentum
   Input syst (string): Systematic
</pre></div></div>
</div>
<p>Most important, each correction has a <code class="docutils literal notranslate"><span class="pre">.evaluate(...)</span></code> method that accepts scalars or numpy arrays:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ceval[&quot;phimod&quot;].evaluate(1.2, -1)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0278771158865732
</pre></div></div>
</div>
<p>Note that the input types are strict (not coerced) to help catch bugs early, e.g.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># will not work
# ceval[&quot;phimod&quot;].evaluate(1.2, -1.0)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
ptvals = np.random.exponential(15.0, size=10)

ceval[&quot;ptweight&quot;].evaluate(ptvals, &quot;nominal&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([1.1 , 1.02, 1.1 , 1.1 , 1.1 , 1.1 , 1.1 , 1.08, 1.1 , 1.02])
</pre></div></div>
</div>
<p>Currently, only numpy-compatible awkward arrays are accepted, but a jagged array can be flattened and re-wrapped quite easily:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import awkward as ak

ptjagged = ak.Array([[10.1, 20.2, 30.3], [40.4, 50.5], [60.6]])

ptflat, counts = ak.flatten(ptjagged), ak.num(ptjagged)
weight = ak.unflatten(
    ceval[&quot;ptweight&quot;].evaluate(ptflat, &quot;nominal&quot;),
    counts=counts,
)
weight
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Array [[1.1, 1.08, 1.06], ... 1.02], [1.02]] type=&#39;3 * var * float64&#39;&gt;
</pre></div></div>
</div>
</section>
<section id="Creating-new-corrections">
<h2>Creating new corrections<a class="headerlink" href="#Creating-new-corrections" title="Link to this heading">ïƒ</a></h2>
<p>Alongside the evaluator we just demonstrated, <code class="docutils literal notranslate"><span class="pre">correctionlib</span></code> also contains a complete JSON Schema defining the expected fields and types found in a correction json object. The complete schema (version 2) is defined in the <a class="reference external" href="https://cms-nanoaod.github.io/correctionlib/schemav2.html">documentation</a>. In the package, we use <a class="reference external" href="https://pydantic-docs.helpmanual.io/">pydantic</a> to help us validate the data and build correction objects in an easier way. The basic object is the <code class="docutils literal notranslate"><span class="pre">Correction</span></code> which,
besides some metadata like a name and version, defines upfront the inputs and output. Below we make our first correction, which will always return <code class="docutils literal notranslate"><span class="pre">1.1</span></code> as the output:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import correctionlib.schemav2 as cs

corr = cs.Correction(
    name=&quot;ptweight&quot;,
    version=1,
    inputs=[
        cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Muon transverse momentum&quot;),
    ],
    output=cs.Variable(name=&quot;weight&quot;, type=&quot;real&quot;, description=&quot;Multiplicative event weight&quot;),
    data=1.1,
)
corr
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Correction(name=&#39;ptweight&#39;, description=None, version=1, inputs=[Variable(name=&#39;pt&#39;, type=&#39;real&#39;, description=&#39;Muon transverse momentum&#39;)], output=Variable(name=&#39;weight&#39;, type=&#39;real&#39;, description=&#39;Multiplicative event weight&#39;), generic_formulas=None, data=1.1)
</pre></div></div>
</div>
<p>The resulting object can be manipulated in-place as needed. Note that this correction object is not an evluator instance as we saw before. We can convert from the schema to an evaluator with the <code class="docutils literal notranslate"><span class="pre">.to_evaluator()</span></code> function:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>corr.to_evaluator().evaluate(12.3)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.1
</pre></div></div>
</div>
<p>A nicer printout is also available through <code class="docutils literal notranslate"><span class="pre">rich</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import rich

rich.print(corr)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">ptweight</span> <span style="font-weight: bold">(</span>v1<span style="font-weight: bold">)</span>
<span style="font-style: italic">No description</span>
Node counts:
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">pt</span> (real)                  â”‚
â”‚ Muon transverse momentum   â”‚
â”‚ Range: <span style="color: #800000; text-decoration-color: #800000; font-weight: bold">unused</span>, overflow ok â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—€ output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">weight</span> (real)               â”‚
â”‚ Multiplicative event weight â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">data=</span></code> field of the correction is the root node of a tree of objects defining how the correction is to be evaluated. In the first example, it simply terminates at this node, returning always the float value <code class="docutils literal notranslate"><span class="pre">1.1</span></code>. We have many possible node types:</p>
<ul class="simple">
<li><p>Binning: for 1D binned variable, each bin can be any type;</p></li>
<li><p>MultiBinning: an optimization for nested 1D Binnings, this can lookup n-dimensional binned values;</p></li>
<li><p>Category: for discrete dimensions, either integer or string types;</p></li>
<li><p>Formula: arbitrary formulas in up to four (real or integer-valued) input variables;</p></li>
<li><p>FormulaRef: an optimization for repeated use of the same formula with different coefficients;</p></li>
<li><p>Transform: useful to rewrite an input for all downstream nodes;</p></li>
<li><p>HashPRNG: a deterministic pseudorandom number generator; and</p></li>
<li><p>float: a constant value</p></li>
</ul>
<p>Letâ€™s create our first binned correction. Weâ€™ll have to decide how to handle inputs that are out of range with the <code class="docutils literal notranslate"><span class="pre">flow=</span></code> attribute. Try switching <code class="docutils literal notranslate"><span class="pre">&quot;clamp&quot;</span></code> with <code class="docutils literal notranslate"><span class="pre">&quot;error&quot;</span></code> or another content node.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ptweight = cs.Correction(
    name=&quot;ptweight&quot;,
    version=1,
    inputs=[cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Muon transverse momentum&quot;)],
    output=cs.Variable(name=&quot;weight&quot;, type=&quot;real&quot;, description=&quot;Multiplicative event weight&quot;),
    data=cs.Binning(
        nodetype=&quot;binning&quot;,
        input=&quot;pt&quot;,
        edges=[10, 20, 30, 40, 50, 80, 120],
        content=[1.1, 1.08, 1.06, 1.04, 1.02, 1.0],
        flow=&quot;clamp&quot;,
    ),
)

rich.print(ptweight)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">ptweight</span> <span style="font-weight: bold">(</span>v1<span style="font-weight: bold">)</span>
<span style="font-style: italic">No description</span>
Node counts: <span style="font-weight: bold">Binning</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">pt</span> (real)                         â”‚
â”‚ Muon transverse momentum          â”‚
â”‚ Range: [10.0, 120.0), overflow ok â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—€ output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">weight</span> (real)               â”‚
â”‚ Multiplicative event weight â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ptweight.to_evaluator().evaluate(230.0)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0
</pre></div></div>
</div>
</section>
<section id="Formulas">
<h2>Formulas<a class="headerlink" href="#Formulas" title="Link to this heading">ïƒ</a></h2>
<p>Formula support currently includes a mostly-complete subset of the ROOT library TFormula class, and is implemented in a threadsafe standalone manner. The parsing grammar is formally defined and parsed through the use of a header-only PEG parser library. This allows for extremely fast parsing of thousands of formulas encountered sometimes in binned formula (spline) correction types. Below we demonstrate a simple formula for a made-up <span class="math notranslate nohighlight">\(\phi\)</span>-dependent efficiency correction. This also
demonstrates nesting a content node inside another for the first time, with the outer Category node defining which formula to use depending on the particle charge</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>phimod = cs.Correction(
    name=&quot;phimod&quot;,
    description=&quot;Phi-dependent tracking efficiency, or something?&quot;,
    version=1,
    inputs=[
        cs.Variable(name=&quot;phi&quot;, type=&quot;real&quot;),
        cs.Variable(name=&quot;q&quot;, type=&quot;int&quot;, description=&quot;Particle charge&quot;),
    ],
    output=cs.Variable(name=&quot;weight&quot;, type=&quot;real&quot;, description=&quot;Multiplicative event weight&quot;),
    data=cs.Category(
        nodetype=&quot;category&quot;,
        input=&quot;q&quot;,
        content=[
            cs.CategoryItem(
                key=1,
                value=cs.Formula(
                    nodetype=&quot;formula&quot;,
                    variables=[&quot;phi&quot;],
                    parser=&quot;TFormula&quot;,
                    expression=&quot;(1+0.1*sin(x+0.3))/(1+0.07*sin(x+0.4))&quot;,
                ),
            ),
            cs.CategoryItem(
                key=-1,
                value=cs.Formula(
                    nodetype=&quot;formula&quot;,
                    variables=[&quot;phi&quot;],
                    parser=&quot;TFormula&quot;,
                    expression=&quot;(1+0.1*sin(x+0.31))/(1+0.07*sin(x+0.39))&quot;,
                ),
            ),
        ]
    ),
)
rich.print(phimod)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">phimod</span> <span style="font-weight: bold">(</span>v1<span style="font-weight: bold">)</span>
Phi-dependent tracking efficiency, or something?
Node counts: <span style="font-weight: bold">Category</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="font-weight: bold">Formula</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">phi</span> (real)                      â”‚ â”‚ <span style="font-weight: bold">q</span> (int)         â”‚
â”‚ <span style="font-style: italic">No description</span>                  â”‚ â”‚ Particle charge â”‚
â”‚ Range: [-inf, inf), overflow ok â”‚ â”‚ Values: -1, 1   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—€ output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">weight</span> (real)               â”‚
â”‚ Multiplicative event weight â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>phimod.to_evaluator().evaluate(1.23, 1)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0280774577481218
</pre></div></div>
</div>
<p>Try evaluating the correction for a neutral particle (<code class="docutils literal notranslate"><span class="pre">charge=0</span></code>) What can we change to the above definition to allow it to return a reasonable value for neutral particles rather than an error?</p>
</section>
<section id="Converting-from-histograms">
<h2>Converting from histograms<a class="headerlink" href="#Converting-from-histograms" title="Link to this heading">ïƒ</a></h2>
<p>Often one wants to convert a histogram into a correction object. Here we show how to do that using histgrams made with the <a class="reference external" href="https://hist.readthedocs.io/en/latest/">hist</a> package, but any histogram that respects the <a class="reference external" href="https://uhi.readthedocs.io/en/latest/plotting.html#plotting">Unified Histogram Interface Plottable</a> protocol (including, for example, ROOT TH1s) should work as well.</p>
<p>Note: some of the conversion utilities require extra packages installed. The simplest way to ensure you have all dependencies is via the <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">correctionlib[convert]</span></code> extras configuration.</p>
<p>Here we create some mock data for two slightly different pt and eta spectra (say, from two different generators) and derive a correction to reweight one sample to the other.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import hist
import matplotlib.pyplot as plt

dists = (
    hist.Hist.new
    .StrCat([&quot;gen1&quot;, &quot;gen2&quot;], name=&quot;dataset&quot;, growth=True)
    .Reg(20, 0, 100, name=&quot;pt&quot;)
    .Reg(4, -3, 3, name=&quot;eta&quot;)
    .Weight()
    .fill(
        dataset=&quot;gen1&quot;,
        pt=np.random.exponential(scale=10.0, size=10000) + np.random.exponential(scale=10.0, size=10000),
        eta=np.random.normal(scale=1, size=10000)
    )
    .fill(
        dataset=&quot;gen2&quot;,
        pt=np.random.exponential(scale=10.0, size=10000) + np.random.exponential(scale=15.0, size=10000),
        eta=np.random.normal(scale=1.1, size=10000)
    )
)

fig, ax = plt.subplots()
dists[:, :, sum].plot1d(ax=ax)
ax.legend(title=&quot;dataset&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1214b6380&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/correctionlib_tutorial_26_1.png" src="_images/correctionlib_tutorial_26_1.png" />
</div>
</div>
<p>Now we derive a correction as a function of <span class="math notranslate nohighlight">\(p_T\)</span> and <span class="math notranslate nohighlight">\(\eta\)</span> to <code class="docutils literal notranslate"><span class="pre">gen2</span></code> such that it agrees with <code class="docutils literal notranslate"><span class="pre">gen1</span></code>. Weâ€™ll set it to 1 anywhere we run out of statistics for the correction, to avoid divide by zero issues.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>num = dists[&quot;gen1&quot;, :, :].values()
den = dists[&quot;gen2&quot;, :, :].values()
sf = np.where(
    (num &gt; 0) &amp; (den &gt; 0),
    num / np.maximum(den, 1) * den.sum() / num.sum(),
    1.0,
)

# a quick way to plot the scale factor is to steal the axis definitions from the input histograms:
sfhist = hist.Hist(*dists.axes[1:], data=sf)
sfhist.plot2d()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ColormeshArtists(pcolormesh=&lt;matplotlib.collections.QuadMesh object at 0x130968490&gt;, cbar=&lt;matplotlib.colorbar.Colorbar object at 0x130969810&gt;, text=[])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/correctionlib_tutorial_28_1.png" src="_images/correctionlib_tutorial_28_1.png" />
</div>
</div>
<p>Now we use <code class="docutils literal notranslate"><span class="pre">correctionlib.convert.from_histogram(...)</span></code> to convert the scale factor into a correction object</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import correctionlib.convert

# without a name, the resulting object will fail validation
sfhist.name = &quot;gen2_to_gen1&quot;
sfhist.label = &quot;out&quot;
gen2_to_gen1 = correctionlib.convert.from_histogram(sfhist)
gen2_to_gen1.description = &quot;Reweights gen2 to agree with gen1&quot;
# set overflow bins behavior (default is to raise an error when out of bounds)
gen2_to_gen1.data.flow = &quot;clamp&quot;
rich.print(gen2_to_gen1)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">gen2_to_gen1</span> <span style="font-weight: bold">(</span>v0<span style="font-weight: bold">)</span>
Reweights gen2 to agree with gen1
Node counts: <span style="font-weight: bold">MultiBinning</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">pt</span> (real)                        â”‚ â”‚ <span style="font-weight: bold">eta</span> (real)                      â”‚
â”‚ pt                               â”‚ â”‚ eta                             â”‚
â”‚ Range: [0.0, 100.0), overflow ok â”‚ â”‚ Range: [-3.0, 3.0), overflow ok â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€ â—€ output â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">out</span> (real)     â”‚
â”‚ <span style="font-style: italic">No description</span> â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<p>Now we generate some new mock data as if it was drawn from <code class="docutils literal notranslate"><span class="pre">gen2</span></code> and reweight it with our correction. Letâ€™s see if our correction closes:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ptvals = np.random.exponential(scale=10.0, size=10000) + np.random.exponential(scale=15.0, size=10000)
etavals = np.random.normal(scale=1.1, size=10000)

dists.fill(
    dataset=&quot;gen2rwt&quot;,
    pt=ptvals,
    eta=etavals,
    weight=gen2_to_gen1.to_evaluator().evaluate(ptvals, etavals)
)

fig, ax = plt.subplots()
dists[:, :, sum].plot1d(ax=ax)
ax.legend(title=&quot;dataset&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1308b88b0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/correctionlib_tutorial_32_1.png" src="_images/correctionlib_tutorial_32_1.png" />
</div>
</div>
</section>
<section id="Polynomial-fits">
<h2>Polynomial fits<a class="headerlink" href="#Polynomial-fits" title="Link to this heading">ïƒ</a></h2>
<p>It is apparent from the plot of the 2D correction factor that we do not have sufficient sample statistics to derive a smooth correction. One approach to improve the quality is to fit it to a polynomial. A utility method, <code class="docutils literal notranslate"><span class="pre">correctionlib.convert.ndpolyfit</span></code> allows to fit an arbitrary-dimensional polynomial to a set of data points and return a correction object representing the result.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>centers = np.meshgrid(*[ax.centers for ax in sfhist.axes], indexing=&quot;ij&quot;)

gen2_to_gen1_poly, fit = correctionlib.convert.ndpolyfit(
    points=[c.flatten() for c in centers],
    values=sfhist.values().flatten(),
    weights=1/sfhist.variances().flatten(),
    varnames=[ax.name for ax in sfhist.axes],
    degree=(2, 2),
)
gen2_to_gen1_poly.name = &quot;gen2_to_gen1_poly&quot;
rich.print(gen2_to_gen1_poly)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">gen2_to_gen1_poly</span> <span style="font-weight: bold">(</span>v1<span style="font-weight: bold">)</span>
Fit to polynomial of order <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>
Fit status: The unconstrained solution is optimal.
chi2 = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.305322148600006</span>, <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">P</span><span style="font-weight: bold">(</span><span style="color: #808000; text-decoration-color: #808000">dof</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">71</span><span style="font-weight: bold">)</span> = <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.000</span>
Node counts: <span style="font-weight: bold">Formula</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">pt</span> (real)                       â”‚ â”‚ <span style="font-weight: bold">eta</span> (real)                      â”‚
â”‚ <span style="font-style: italic">No description</span>                  â”‚ â”‚ <span style="font-style: italic">No description</span>                  â”‚
â”‚ Range: [-inf, inf), overflow ok â”‚ â”‚ Range: [-inf, inf), overflow ok â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€ â—€ output â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">output</span> (real)  â”‚
â”‚ <span style="font-style: italic">No description</span> â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<p>Letâ€™s check the closure of this method to the previous one:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dists.fill(
    dataset=&quot;gen2rwt_poly&quot;,
    pt=ptvals,
    eta=etavals,
    weight=gen2_to_gen1_poly.to_evaluator().evaluate(ptvals, etavals)
)


fig, ax = plt.subplots()
dists[:, :, sum].plot1d(ax=ax)
ax.legend(title=&quot;dataset&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x130a1ad10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/correctionlib_tutorial_36_1.png" src="_images/correctionlib_tutorial_36_1.png" />
</div>
</div>
<p>Another important consideration is that evaluating a polynomial in Horner form is <span class="math notranslate nohighlight">\(O(k)\)</span> where <span class="math notranslate nohighlight">\(k\)</span> is the order of the polynomial, while looking up a value in a non-uniform binning is <span class="math notranslate nohighlight">\(O(log(n))\)</span> in <span class="math notranslate nohighlight">\(n\)</span> bins. Depending on the situation, an acceptable <span class="math notranslate nohighlight">\(k\)</span> may be lower than <span class="math notranslate nohighlight">\(log(n)\)</span>. In our case, the <span class="math notranslate nohighlight">\((2,2)\)</span> polynomial we derived evaluates slower than the binning, partially because it is not evaluated in Horner form:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>corr_bin = gen2_to_gen1.to_evaluator()
corr_pol = gen2_to_gen1_poly.to_evaluator()

%timeit corr_bin.evaluate(ptvals, etavals)
%timeit corr_pol.evaluate(ptvals, etavals)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
404 Âµs Â± 3.54 Âµs per loop (mean Â± std. dev. of 7 runs, 1,000 loops each)
3.28 ms Â± 59.2 Âµs per loop (mean Â± std. dev. of 7 runs, 100 loops each)
</pre></div></div>
</div>
<p>However, in an alternative situation, the same may not hold:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%timeit np.searchsorted([0.,  5., 10., 15., 20., 25., 30., 35.], ptvals)
%timeit np.polyval([0.01, 0.1, 1.0], ptvals)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
199 Âµs Â± 4.31 Âµs per loop (mean Â± std. dev. of 7 runs, 1,000 loops each)
36.6 Âµs Â± 1.65 Âµs per loop (mean Â± std. dev. of 7 runs, 10,000 loops each)
</pre></div></div>
</div>
</section>
<section id="Resolution-models">
<h2>Resolution models<a class="headerlink" href="#Resolution-models" title="Link to this heading">ïƒ</a></h2>
<p>In some instances, one might want to smear the value of a variable, e.g. jet energy, to simulate a degradation of resolution with respect to what was expected from simulation. If we can deterministically generate pseudorandom numbers, we can then use them after suitable scaling to correct the jet momentum. To do so in correctionlib, we gather entropy sources such as the kinematics of the jet and event-level quantities, hash them together using the extremely fast
<a class="reference external" href="https://cyan4973.github.io/xxHash/">xxhash</a> algorithm to generate an integer seed, and use that to initialize a <a class="reference external" href="https://www.pcg-random.org/">PCG64</a> random number generator, which can then be drawn from to build a normal-distributed (or otherwise) value. See <a class="reference external" href="https://github.com/cms-nanoAOD/correctionlib/issues/130">issue #130</a> for further details.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>resrng = cs.Correction(
    name=&quot;resrng&quot;,
    description=&quot;Deterministic smearing value generator&quot;,
    version=1,
    inputs=[
        cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Unsmeared jet pt&quot;),
        cs.Variable(name=&quot;eta&quot;, type=&quot;real&quot;, description=&quot;Jet pseudorapdity&quot;),
        cs.Variable(name=&quot;phi&quot;, type=&quot;real&quot;, description=&quot;Jet phi (entropy source)&quot;),
        cs.Variable(name=&quot;evt&quot;, type=&quot;int&quot;, description=&quot;Event number (entropy source)&quot;),
    ],
    output=cs.Variable(name=&quot;rng&quot;, type=&quot;real&quot;),
    data=cs.HashPRNG(
        nodetype=&quot;hashprng&quot;,
        inputs=[&quot;pt&quot;, &quot;eta&quot;, &quot;phi&quot;, &quot;evt&quot;],
        distribution=&quot;stdnormal&quot;,
    )
)

resmodel = cs.Correction(
    name=&quot;resmodel&quot;,
    description=&quot;A jet energy resolution smearing model&quot;,
    version=1,
    inputs=[
        cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Unsmeared jet pt&quot;),
    ],
    output=cs.Variable(name=&quot;scale&quot;, type=&quot;real&quot;),
    data=cs.Binning(
        nodetype=&quot;binning&quot;,
        input=&quot;pt&quot;,
        edges=[10, 20, 30, 40, 50, 80, 120],
        content=[0.3, 0.25, 0.20, 0.14, 0.06, 0.02],
        flow=&quot;clamp&quot;,
    )
)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># dummy distributions
phivals = np.random.uniform(-np.pi, np.pi, size=10000)
eventnumber = np.random.randint(123456, 123567, size=10000)

# apply a pT-dependent smearing by scaling the standard normal draw
smear_val = (
    resrng.to_evaluator().evaluate(ptvals, etavals, phivals, eventnumber)
    * resmodel.to_evaluator().evaluate(ptvals)
)
pt_smeared = np.maximum(ptvals + smear_val, 0.0)


fig, ax = plt.subplots()
ax.hist(pt_smeared - ptvals, bins=50)
ax.set_xlabel(&quot;Smeared $p_T$ - Unsmeared $p_T$&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;Smeared $p_T$ - Unsmeared $p_T$&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/correctionlib_tutorial_43_1.png" src="_images/correctionlib_tutorial_43_1.png" />
</div>
</div>
</section>
<section id="Chaining-with-CompoundCorrection">
<h2>Chaining with CompoundCorrection<a class="headerlink" href="#Chaining-with-CompoundCorrection" title="Link to this heading">ïƒ</a></h2>
<p>A CompoundCorrection allows to apply a sequence of corrections in order, refering to other corrections in the same CorrectionSet object. For example, we can merge the smearing and RNG into one:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cset = correctionlib.schemav2.CorrectionSet(
    schema_version=2,
    corrections=[
        resmodel,
        resrng,
    ],
    compound_corrections=[
        cs.CompoundCorrection(
            name=&quot;resolution_model&quot;,
            inputs=[
                cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Unsmeared jet pt&quot;),
                cs.Variable(name=&quot;eta&quot;, type=&quot;real&quot;, description=&quot;Jet pseudorapdity&quot;),
                cs.Variable(name=&quot;phi&quot;, type=&quot;real&quot;, description=&quot;Jet phi (entropy source)&quot;),
                cs.Variable(name=&quot;evt&quot;, type=&quot;int&quot;, description=&quot;Event number (entropy source)&quot;),
            ],
            output=cs.Variable(name=&quot;shift&quot;, type=&quot;real&quot;, description=&quot;Additive shift to jet pT&quot;),
            inputs_update=[],
            input_op=&quot;*&quot;,
            output_op=&quot;*&quot;,
            stack=[&quot;resmodel&quot;, &quot;resrng&quot;],
        )
    ]
)

oneshot = cset.to_evaluator().compound[&quot;resolution_model&quot;]

print(&quot;One-shot smearing is equivalent to two-step procedure?&quot;)
print(np.allclose(
    oneshot.evaluate(ptvals, etavals, phivals, eventnumber),
    smear_val,
))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
One-shot smearing is equivalent to two-step procedure?
True
</pre></div></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">inputs_update</span></code> and <code class="docutils literal notranslate"><span class="pre">input_op</span></code> fields can be used to update inputs as they go through the stack, which is useful for chained corrections such as jet energy corrections.</p>
</section>
<section id="Systematics">
<h2>Systematics<a class="headerlink" href="#Systematics" title="Link to this heading">ïƒ</a></h2>
<p>There are many ways to encode systematic uncertainties within correctionlib, although no nodes are dedicated to the task. See <a class="reference external" href="https://github.com/cms-nanoAOD/correctionlib/issues/4">issue #4</a> to discuss further the idea of having a dedicated systematic node. The most straightforward option is to use a Category node with string lookup to switch the behavior depending on the active systematic. Below we modify our <code class="docutils literal notranslate"><span class="pre">ptweight</span></code> from before to produce a systematically larger event weight when the
<code class="docutils literal notranslate"><span class="pre">MuonEffUp</span></code> systematic is specified, while producing the nominal event weight for any other string key, by taking advantage of the <code class="docutils literal notranslate"><span class="pre">default=</span></code> keywoard in the Category node. We also use the <code class="docutils literal notranslate"><span class="pre">flow=</span></code> keyword in the shifted binning to increase the systematic uncertainty for data with muon <span class="math notranslate nohighlight">\(p_T\)</span> larger than 120.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ptweight = cs.Correction(
    name=&quot;ptweight&quot;,
    version=1,
    inputs=[
        cs.Variable(name=&quot;pt&quot;, type=&quot;real&quot;, description=&quot;Muon transverse momentum&quot;),
        cs.Variable(name=&quot;syst&quot;, type=&quot;string&quot;, description=&quot;Systematic&quot;)
    ],
    output=cs.Variable(name=&quot;weight&quot;, type=&quot;real&quot;, description=&quot;Multiplicative event weight&quot;),
    data=cs.Category(
        nodetype=&quot;category&quot;,
        input=&quot;syst&quot;,
        content=[
            cs.CategoryItem(
                key=&quot;MuonEffUp&quot;,
                value=cs.Binning(
                    nodetype=&quot;binning&quot;,
                    input=&quot;pt&quot;,
                    edges=[0, 10, 20, 30, 40, 50, 80, 120],
                    content=[1.14, 1.14, 1.09, 1.07, 1.05, 1.03, 1.01],
                    flow=1.03,
                ),
            ),
        ],
        default=cs.Binning(
            nodetype=&quot;binning&quot;,
            input=&quot;pt&quot;,
            edges=[10, 20, 30, 40, 50, 80, 120],
            content=[1.1, 1.08, 1.06, 1.04, 1.02, 1.0],
            flow=&quot;clamp&quot;,
        ),
    ),
)

rich.print(ptweight)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">ğŸ“ˆ <span style="font-weight: bold">ptweight</span> <span style="font-weight: bold">(</span>v1<span style="font-weight: bold">)</span>
<span style="font-style: italic">No description</span>
Node counts: <span style="font-weight: bold">Category</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>, <span style="font-weight: bold">Binning</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â•­â”€â”€â”€â”€â”€ â–¶ input â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">pt</span> (real)                        â”‚ â”‚ <span style="font-weight: bold">syst</span> (string)     â”‚
â”‚ Muon transverse momentum         â”‚ â”‚ Systematic        â”‚
â”‚ Range: [0.0, 120.0), overflow ok â”‚ â”‚ Values: MuonEffUp â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â”‚ <span style="color: #008000; text-decoration-color: #008000; font-weight: bold">has default</span>       â”‚
                                     â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€ â—€ output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ <span style="font-weight: bold">weight</span> (real)               â”‚
â”‚ Multiplicative event weight â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ptweight.to_evaluator().evaluate(135., &quot;nominal&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0
</pre></div></div>
</div>
</section>
<section id="Writing-it-all-out">
<h2>Writing it all out<a class="headerlink" href="#Writing-it-all-out" title="Link to this heading">ïƒ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cset = correctionlib.schemav2.CorrectionSet(
    schema_version=2,
    description=&quot;my custom corrections&quot;,
    corrections=[
        gen2_to_gen1,
        ptweight,
        phimod,
    ],
)

with open(&quot;mycorrections.json&quot;, &quot;w&quot;) as fout:
    fout.write(cset.json(exclude_unset=True))

import gzip

with gzip.open(&quot;mycorrections.json.gz&quot;, &quot;wt&quot;) as fout:
    fout.write(cset.json(exclude_unset=True))
</pre></div>
</div>
</div>
</section>
<section id="Command-line-utility">
<h2>Command-line utility<a class="headerlink" href="#Command-line-utility" title="Link to this heading">ïƒ</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">correction</span></code> utility, bundled with the library, provides useful tools for viewing, combining, and validating correction json sets. It also can provide the necessary compile flags for C++ programs to use correctionlib:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!correction --help
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
usage: correction [-h] [--width WIDTH] [--html HTML]
                  {validate,summary,merge,config} ...

Command-line interface to correctionlib

positional arguments:
  {validate,summary,merge,config}
    validate            Check if all files are valid
    summary             Print a summmary of the corrections
    merge               Merge one or more correction files and print to stdout
    config              Configuration and linking information

options:
  -h, --help            show this help message and exit
  --width WIDTH         Rich output width
  --html HTML           Save terminal output to an HTML file
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!correction config -h
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
usage: correction config [-h] [-v] [--incdir] [--cflags] [--libdir]
                         [--ldflags] [--rpath] [--cmake]

options:
  -h, --help     show this help message and exit
  -v, --version
  --incdir
  --cflags
  --libdir
  --ldflags
  --rpath        Include library path hint in linker
  --cmake        CMake dependency flags
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%file main.cc
#include &lt;iostream&gt;
#include &quot;correction.h&quot;

int main() {
    auto cset = correction::CorrectionSet::from_file(&quot;mycorrections.json.gz&quot;);

    double val = cset-&gt;at(&quot;ptweight&quot;)-&gt;evaluate({15.0, &quot;nominal&quot;});
    std::cout &lt;&lt; val &lt;&lt; std::endl;
    return 0;
}
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting main.cc
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!g++ main.cc -o main $(correction config --cflags --ldflags --rpath)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ld: warning: dylib (/usr/local/lib/python3.10/site-packages/correctionlib/lib/libcorrectionlib.dylib) was built for newer macOS version (12.0) than being linked (11.0)
</pre></div></div>
</div>
<p>On some platforms, if you see errors such as</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>main.cc:(.text+0x17d): undefined reference to `correction::CorrectionSet::from_file(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;)&#39;
</pre></div>
</div>
<p>in the above compilation, you may need to add <code class="docutils literal notranslate"><span class="pre">-D_GLIBCXX_USE_CXX11_ABI=0</span></code> to the arguments.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!./main
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.1
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="highlevel.html" class="btn btn-neutral float-right" title="correctionlib.highlevel" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, nsmith-.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>